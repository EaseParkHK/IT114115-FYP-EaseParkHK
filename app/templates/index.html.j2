{% extends "base.html.j2" %}
{% import 'bootstrap/wtf.html' as wtf %}
{% block head %}
<title>EaseParkHK</title>
<link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
{% endblock %}
{% block app_content %}
{% include "special_traffic_news.html.j2" %}
<div class="container mt-5">
    <h1 class="text-center mb-4">Parking Information</h1>

    <!-- Filter Options -->
    <div class="form-group mt-4">
        <label for="vehicle-type">Vehicle Type:</label>
        <select id="vehicle-type" class="form-control" onchange="filterCarParks()">
            <option value="privateCar">Private Car</option>
            <option value="motorCycle">Motorcycle</option>
            <option value="HGV">Heavy Goods Vehicle</option>
            <option value="LGV">Light Goods Vehicle</option>
            <option value="coach">Coach</option>
        </select>
    </div>

    <!-- Operating Status Filter -->
    <div class="form-group">
        <label for="status-filter">Status:</label>
        <select id="status-filter" class="form-control" onchange="filterCarParksByStatus()">
            <option value="all">All</option>
            <option value="OPEN">Open</option>
            <option value="CLOSED">Closed</option>
        </select>
    </div>

    {% if favorite_carparks %}
    <h2>Favorite Parking Lots</h2>
    <table class="table table-striped table-hover mt-4">
        <thead class="thead-dark">
            <tr>
                <th onclick="sortTable(0)">Name <span class="sort-icon">▲</span></th>
                <th onclick="sortTable(1)">Address <span class="sort-icon">▲</span></th>
                <th onclick="sortTable(2)">Operating Status <span class="sort-icon">▲</span></th>
                <th onclick="sortTable(3)">Vacancies <span class="sort-icon">▲</span></th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="favorite-carpark-table">
            {% for carpark in favorite_carparks %}
                {% for vehicle_type in ['privateCar', 'motorCycle', 'LGV', 'HGV', 'coach'] %}
                    {% set vacancy = carpark[vehicle_type ~ '_vacancy'] %}
                    {% if vacancy not in ['N/A', 'none', '-1', '0'] %}
                        <tr data-vehicle-type="{{ vehicle_type }}" data-park-id="{{ carpark.park_id }}">
                            <td>{{ carpark.name }}</td>
                            <td>{{ carpark.displayAddress }}</td>
                            <td>{{ carpark.opening_status }}</td>
                            <td>{{ vacancy }}</td>
                            <td>
                                <div class="btn-group">
                                    <a href="{{ url_for('carpark_detail', park_id=carpark.park_id) }}" class="btn btn-info btn-sm">Details</a>
                                    <button class="btn btn-primary btn-sm" onclick="showMap('{{ carpark.latitude }}', '{{ carpark.longitude }}', '{{ carpark.name }}', '{{ carpark.displayAddress }}', '{{ carpark.opening_status }}', '{{ vacancy }}', '{{ vehicle_type }}')">Map</button>
                                    <button class="btn btn-warning btn-sm" onclick="toggleFavorite('{{ carpark.park_id }}')">Remove Favorite</button>
                                </div>
                            </td>
                        </tr>
                    {% endif %}
                {% endfor %}
            {% endfor %}
        </tbody>
    </table>
    {% endif %}

    <h2>All Parking Lots</h2>
    <table class="table table-striped table-hover mt-4">
        <thead class="thead-dark">
            <tr>
                <th onclick="sortTable(0)">Name <span class="sort-icon">▲</span></th>
                <th onclick="sortTable(1)">Address <span class="sort-icon">▲</span></th>
                <th onclick="sortTable(2)">Operating Status <span class="sort-icon">▲</span></th>
                <th onclick="sortTable(3)">Vacancies <span class="sort-icon">▲</span></th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="carpark-table">
            {% for carpark in carparks %}
                {% for vehicle_type in ['privateCar', 'motorCycle', 'LGV', 'HGV', 'coach'] %}
                    {% set vacancy = carpark[vehicle_type ~ '_vacancy'] %}
                    {% if vacancy not in ['N/A', 'none', '-1', '0'] %}
                        <tr data-vehicle-type="{{ vehicle_type }}" data-park-id="{{ carpark.park_id }}">
                            <td>{{ carpark.name }}</td>
                            <td>{{ carpark.displayAddress }}</td>
                            <td>{{ carpark.opening_status }}</td>
                            <td>{{ vacancy }}</td>
                            <td>
                                <div class="btn-group">
                                    <a href="{{ url_for('carpark_detail', park_id=carpark.park_id) }}" class="btn btn-info btn-sm">Details</a>
                                    <button class="btn btn-primary btn-sm" onclick="showMap('{{ carpark.latitude }}', '{{ carpark.longitude }}', '{{ carpark.name }}', '{{ carpark.displayAddress }}', '{{ carpark.opening_status }}', '{{ vacancy }}', '{{ vehicle_type }}')">Map</button>
                                    <button class="btn btn-warning btn-sm" onclick="toggleFavorite('{{ carpark.park_id }}')">
                                        {{ 'Remove Favorite' if carpark.park_id in favorite_carparks else 'Add Favorite' }}
                                    </button>
                                </div>
                            </td>
                        </tr>
                    {% endif %}
                {% endfor %}
            {% endfor %}
        </tbody>
    </table>
    <p id="no-results" class="text-center text-danger font-weight-bold mt-4" style="display: none;">
        No results found. Please adjust the filter conditions or try again.
    </p>
</div>

<style>
    @media (max-width: 650px) {
        .container {
            padding: 0 10px;
        }

        h1, h2 {
            font-size: 1.5rem;
            text-align: center;
        }

        table {
            font-size: 0.9rem;
        }

        th, td {
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .form-group label {
            font-size: 0.9rem;
        }

        .form-control {
            font-size: 0.9rem;
        }

        .btn {
            font-size: 0.8rem;
            padding: 5px 10px;
        }

        iframe#map {
            height: 300px;
        }

        .modal-dialog {
            margin: 10px;
        }

        /* Stack buttons vertically under 650px */
        .btn-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
    }

    @media (min-width: 651px) {
        /* Keep buttons in a single line for larger screens */
        .btn-group {
            display: flex;
            flex-wrap: nowrap;
            gap: 5px;
        }
    }

    /* Ensure full width for mobile devices */
    body {
        width: 100%;
        max-width: 100%;
        overflow-x: hidden;
    }
</style>

<script>
    function showMap(lat, long, name, address, status, vacancy, vehicleType) {
        const mapModal = document.getElementById('map-modal');
        const mapFrame = document.getElementById('map');
        mapFrame.src = `https://www.google.com/maps?q=${lat},${long}&output=embed`;
        $('#map-modal').modal('show');

        document.getElementById('carpark-name').textContent = "Name: " + name;
        document.getElementById('carpark-address').textContent = "Address: " + address;
        document.getElementById('carpark-status').textContent = "Status: " + status;
        document.getElementById('carpark-vacancy').textContent = vehicleType.charAt(0).toUpperCase() + vehicleType.slice(1).replace(/([A-Z])/g, ' $1') + " Vacancies: " + vacancy;
    }
</script>
{% endblock %}